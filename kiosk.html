<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‚¤ì˜¤ìŠ¤í¬ - í™”ë©´ ëŒ€ê¸°í‘œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: white;
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .status-bar {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
        }
        
        .current-time {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .service-title {
            text-align: center;
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 40px;
            text-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .course-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .course-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 20px;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            min-width: 250px;
            text-align: center;
        }
        
        .course-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .course-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .course-description {
            font-size: 1.1rem;
            color: #7f8c8d;
        }
        
        /* ëŒ€ê¸°í‘œ íŒì—… */
        .ticket-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .ticket-content {
            background: white;
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .ticket-number {
            font-size: 8rem;
            font-weight: 900;
            color: #e74c3c;
            margin: 30px 0;
            text-shadow: 0 4px 20px rgba(231,76,60,0.3);
        }
        
        .ticket-course {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .ticket-time {
            font-size: 1.3rem;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .qr-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .qr-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .qr-code {
            margin: 0 auto;
        }
        
        .instructions {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .instructions h3 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .instructions p {
            color: #2c3e50;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .close-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .download-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .download-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .download-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .download-btn.secondary {
            background: #f39c12;
        }
        
        .download-btn.secondary:hover {
            background: #e67e22;
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .header h1 { font-size: 2.5rem; }
            .service-title { font-size: 2rem; }
            .course-buttons { flex-direction: column; align-items: center; }
            .course-btn { min-width: 300px; }
            .ticket-number { font-size: 6rem; }
            .ticket-content { padding: 30px; }
        }
    </style>
    
    <!-- QRì½”ë“œ ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ (PDF ìƒì„±ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, off } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuvEDDEoMLwLB2miGHCWX1-B5u8gKlGEQ",
            authDomain: "counter-system-26479.firebaseapp.com",
            databaseURL: "https://counter-system-26479-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "counter-system-26479",
            storageBucket: "counter-system-26479.firebasestorage.app",
            messagingSenderId: "316144964417",
            appId: "1:316144964417:web:8a95a80f9db622f4ee87c0"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ« ìˆœë²ˆëŒ€ê¸°í‘œ ë°œê¸‰</h1>
        </div>

        <div class="status-bar">
            <div class="current-time" id="currentTime"></div>
        </div>

        <div class="main-content">
            <div class="service-title">ì›í•˜ëŠ” ìƒë‹´ ê³¼ì •ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</div>
            
            <div class="course-buttons" id="courseButtons">
                <!-- ê³¼ëª© ë²„íŠ¼ë“¤ -->
            </div>
        </div>
    </div>

    <!-- ëŒ€ê¸°í‘œ íŒì—… -->
    <div class="ticket-popup" id="ticketPopup">
        <div class="ticket-content">
            <h2>âœ¨ ëŒ€ê¸°í‘œê°€ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
            
            <div class="ticket-number" id="ticketNumber">A001</div>
            <div class="ticket-course" id="ticketCourse">ì¤‘êµ­ì–´ ê³¼ì •</div>
            <div class="ticket-time" id="ticketTime">2025-01-01 14:30</div>
            
            <div class="qr-section">
                <div class="qr-title">ğŸ“± ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ ìŠ¤ìº”í•˜ì„¸ìš”</div>
                <canvas id="qrCode" class="qr-code"></canvas>
            </div>
            
            <div class="instructions">
                <h3>ğŸ“‹ ì´ìš© ì•ˆë‚´</h3>
                <p>â€¢ ë°œê¸‰ëœ ë²ˆí˜¸ë¥¼ ê¸°ì–µí•´ ì£¼ì„¸ìš”</p>
                <p>â€¢ ìˆœì„œê°€ ë˜ë©´ í™”ë©´ê³¼ ìŒì„±ìœ¼ë¡œ ì•ˆë‚´ë©ë‹ˆë‹¤</p>
                <p>â€¢ QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ëª¨ë°”ì¼ì—ì„œë„ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                <p>â€¢ ëŒ€ê¸° ì‹œê°„ì€ ì•½ 10-15ë¶„ ì˜ˆìƒë©ë‹ˆë‹¤</p>
            </div>
            
            <div class="download-section">
                <button class="download-btn" onclick="downloadPDF()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
                <button class="download-btn secondary" onclick="shareTicket()">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
            </div>
            
            <button class="close-btn" onclick="closeTicket()">í™•ì¸</button>
        </div>
    </div>

    <script>
        let sharedData = {
            waiting: [],
            counters: Array(6).fill().map((_, i) => ({ id: i + 1, current: null, course: null, count: 0 })),
            totalToday: 0,
            lastUpdated: null
        };
        
        let currentNumbers = {};
        let currentTicketInfo = null;
        
        // ê¸°ë³¸ ê³¼ëª© ì„¤ì •
        const courses = [
            { code: 'CH', name: 'ì¤‘êµ­ì–´ ê³¼ì •', description: 'ì¤‘êµ­ì–´ ê¸°ì´ˆë¶€í„° ê³ ê¸‰ê¹Œì§€' },
            { code: 'EN', name: 'ì˜ì–´ ê³¼ì •', description: 'ì˜ì–´ íšŒí™” ë° ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ì–´' },
            { code: 'HSK', name: 'HSK ì‹œí—˜ë°˜', description: 'HSK 1-6ê¸‰ ì‹œí—˜ ëŒ€ë¹„' },
            { code: 'TO', name: 'TOEIC ì§‘ì¤‘ë°˜', description: 'TOEIC ê³ ë“ì  ëŒ€ë¹„' }
        ];

        // Firebase ì €ì¥
        function saveToFirebase() {
            if (!window.firebaseDB) return;
            
            try {
                sharedData.lastUpdated = new Date().toISOString();
                const systemRef = window.firebaseRef(window.firebaseDB, 'counterSystem');
                window.firebaseSet(systemRef, sharedData);
                console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleString('ko-KR');
        }

        // ê³¼ëª© ë²„íŠ¼ ìƒì„±
        function createCourseButtons() {
            const container = document.getElementById('courseButtons');
            container.innerHTML = '';
            
            courses.forEach(course => {
                const button = document.createElement('button');
                button.className = 'course-btn';
                button.onclick = () => issueTicket(course);
                button.innerHTML = `
                    <div class="course-name">${course.name}</div>
                    <div class="course-description">${course.description}</div>
                `;
                container.appendChild(button);
            });
        }

        // ëŒ€ê¸°í‘œ ë°œê¸‰
        function issueTicket(course) {
            try {
                // ë²ˆí˜¸ ìƒì„±
                if (!currentNumbers[course.code]) {
                    currentNumbers[course.code] = 0;
                }
                currentNumbers[course.code]++;
                
                const number = course.code + String(currentNumbers[course.code]).padStart(3, '0');
                const now = new Date();
                
                // í‹°ì¼“ ì •ë³´ ì €ì¥
                currentTicketInfo = {
                    number: number,
                    course: course.name,
                    time: now.toLocaleString('ko-KR'),
                    timestamp: now.toISOString()
                };
                
                // Firebaseì— ì¶”ê°€
                const newWaitingItem = {
                    number: number,
                    course: course.name,
                    time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                };
                
                sharedData.waiting.push(newWaitingItem);
                sharedData.totalToday = (sharedData.totalToday || 0) + 1;
                
                saveToFirebase();
                showTicket();
                
                console.log('âœ… ëŒ€ê¸°í‘œ ë°œê¸‰ ì™„ë£Œ:', number);
                
            } catch (error) {
                console.error('âŒ ëŒ€ê¸°í‘œ ë°œê¸‰ ì˜¤ë¥˜:', error);
                alert('ëŒ€ê¸°í‘œ ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëŒ€ê¸°í‘œ í‘œì‹œ
        function showTicket() {
            if (!currentTicketInfo) return;
            
            // ì •ë³´ í‘œì‹œ
            document.getElementById('ticketNumber').textContent = currentTicketInfo.number;
            document.getElementById('ticketCourse').textContent = currentTicketInfo.course;
            document.getElementById('ticketTime').textContent = currentTicketInfo.time;
            
            // QRì½”ë“œ ìƒì„±
            generateQRCode();
            
            // íŒì—… í‘œì‹œ
            document.getElementById('ticketPopup').style.display = 'flex';
            
            // 10ì´ˆ í›„ ìë™ ë‹«ê¸°
            setTimeout(() => {
                closeTicket();
            }, 15000);
        }

        // QRì½”ë“œ ìƒì„± (ëª¨ë°”ì¼ í˜ì´ì§€ URL)
        function generateQRCode() {
            // í‹°ì¼“ ì •ë³´ë¥¼ URL ë§¤ê°œë³€ìˆ˜ë¡œ ì¸ì½”ë”©
            const ticketParams = new URLSearchParams({
                number: currentTicketInfo.number,
                ticket: encodeURIComponent(JSON.stringify({
                    number: currentTicketInfo.number,
                    course: currentTicketInfo.course,
                    time: currentTicketInfo.time,
                    timestamp: currentTicketInfo.timestamp
                }))
            });
            
            // ëª¨ë°”ì¼ ëŒ€ê¸°í‘œ í™•ì¸ í˜ì´ì§€ URL ìƒì„±
            const mobilePageURL = `${window.location.origin}/mobile-ticket.html?${ticketParams.toString()}`;
            
            const qr = new QRious({
                element: document.getElementById('qrCode'),
                value: mobilePageURL,
                size: 200,
                background: 'white',
                foreground: 'black',
                level: 'M'
            });
            
            console.log('ğŸ“± QR ì½”ë“œ URL:', mobilePageURL);
        }

        // PDF ë‹¤ìš´ë¡œë“œ
        function downloadPDF() {
            if (!window.jsPDF || !currentTicketInfo) return;
            
            const { jsPDF } = window.jsPDF;
            const pdf = new jsPDF();
            
            // PDF ë‚´ìš© ìƒì„±
            pdf.setFontSize(20);
            pdf.text('ìˆœë²ˆ ëŒ€ê¸°í‘œ', 105, 30, { align: 'center' });
            
            pdf.setFontSize(40);
            pdf.text(currentTicketInfo.number, 105, 60, { align: 'center' });
            
            pdf.setFontSize(16);
            pdf.text(currentTicketInfo.course, 105, 80, { align: 'center' });
            pdf.text('ë°œê¸‰ì‹œê°„: ' + currentTicketInfo.time, 105, 100, { align: 'center' });
            
            pdf.setFontSize(12);
            pdf.text('â€» ìˆœì„œê°€ ë˜ë©´ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤', 105, 120, { align: 'center' });
            pdf.text('â€» ëŒ€ê¸°í‘œë¥¼ ìƒì–´ë²„ë¦¬ì§€ ë§ˆì„¸ìš”', 105, 135, { align: 'center' });
            
            // QRì½”ë“œ ì¶”ê°€ (canvasë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜)
            const canvas = document.getElementById('qrCode');
            const qrImage = canvas.toDataURL('image/png');
            pdf.addImage(qrImage, 'PNG', 80, 150, 50, 50);
            
            pdf.save(`ëŒ€ê¸°í‘œ_${currentTicketInfo.number}.pdf`);
        }

        // ê³µìœ í•˜ê¸°
        function shareTicket() {
            if (!currentTicketInfo) return;
            
            const shareData = {
                title: 'ìˆœë²ˆ ëŒ€ê¸°í‘œ',
                text: `ëŒ€ê¸°ë²ˆí˜¸: ${currentTicketInfo.number}\nê³¼ì •: ${currentTicketInfo.course}\në°œê¸‰ì‹œê°„: ${currentTicketInfo.time}`,
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                // ëŒ€ì²´ ë°©ë²•: í´ë¦½ë³´ë“œ ë³µì‚¬
                const textToCopy = `ëŒ€ê¸°ë²ˆí˜¸: ${currentTicketInfo.number}\nê³¼ì •: ${currentTicketInfo.course}\në°œê¸‰ì‹œê°„: ${currentTicketInfo.time}`;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textToCopy);
                    alert('ëŒ€ê¸°í‘œ ì •ë³´ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert(`ëŒ€ê¸°ë²ˆí˜¸: ${currentTicketInfo.number}\nê³¼ì •: ${currentTicketInfo.course}`);
                }
            }
        }

        // íŒì—… ë‹«ê¸°
        function closeTicket() {
            document.getElementById('ticketPopup').style.display = 'none';
            currentTicketInfo = null;
        }

        // ì´ˆê¸°í™”
        function initialize() {
            console.log('ğŸš€ ê°„ë‹¨í•œ í‚¤ì˜¤ìŠ¤í¬ ì´ˆê¸°í™”');
            
            createCourseButtons();
            updateTime();
            setInterval(updateTime, 1000);
            
            // Firebase ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setTimeout(() => {
                if (window.firebaseDB) {
                    const systemRef = window.firebaseRef(window.firebaseDB, 'counterSystem');
                    window.firebaseOnValue(systemRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            sharedData = { ...sharedData, ...data };
                        }
                    });
                }
            }, 1000);
            
            console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('ticketPopup').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTicket();
            }
        });

        // ì´ˆê¸°í™” ì‹¤í–‰
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
